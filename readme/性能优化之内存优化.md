# 第4章 App内存优化
## 4-1 内存优化介绍及工具选择
    1.内存优化介绍
    2.内存优化工具选择
    
    背景介绍
        内存是大问题但缺乏关注
        压死骆驼的最后一根稻草
    内存问题
        内存抖动：锯齿状、GC导致卡顿
        内存泄漏：可用内存减少、频繁GC
        内存溢出：OOM、程序异常
    工具选择
        Memory Profiler
            实时图标展示应用内存使用量
            识别内存泄漏、抖动等
            提供捕获堆转储、强制GC以及跟踪内存分配的能力
            特点：方便直观
                  线下平时使用
        Memory Analyzer（MAT）
            强大的Java Heap分析工具，查找内存泄漏及内存占用
            生成整体报告、分析问题等
            线下深入使用
        LeakCanary
            自动内存泄漏检测
            线下使用
    总结
        内存问题及优化工具
## 4-2 Android 内存管理机制
    Java内存管理机制
        （1）方法区
        （2）虚拟机栈
        （3）本地方法栈
        （4）堆
        （5）程序计数器
        
        Java内存回收算法
            （1）标记-清楚算法
                .标记出所有需要回收的对象
                .统一回收所有被标记的对象
                特点：标记和清楚效率不高
                      产生大量不连续的内存碎片
            （2）复制算法
                .将内存划分为大小相等的两块
                .一块内存用完之后复制存活对象到另一块
                .清理另一块内存
                总结：实现简单，运行高效
                      浪费一半控件，代价大
            （3）标记-整理算法
                .标记过程与“标记-清楚”算法一样
                .存活对象往一端进行移动
                .清理其余内存
                特点：避免“标记-清除”算法导致的内存碎片
                      避免“复制”算法的空间浪费
            （4）分代收集算法
                .结合多种收集算法优势
                .新生代对象存活率低，复制
    Android内存管理机制
        内存弹性分配，分配值与最大值受具体设备影响
        OOM场景：内存真正不足、可用内存不足
        
        Dalvik与Art区别
            .Dalvik仅固定一种回收算法
            .Art回收算法可运行期选择（5.0后）
            .Art具备内存整理能力，减少内存空洞
            
        Low Memory Killer
            针对所有进程
            .进程分类：前台进程、可见进程、服务进程、后台进程、空进程
            .回收收益
            
    总结
        Java及Android的内存管理机制

### 内存抖动解决实战
    内存抖动介绍
        定义：内存频繁分配和回收导致内存不稳定
        表现：频繁GC、内存曲线呈锯齿状
        危害：导致卡顿、OOM
    疑问：为什么内存抖动会导致OOM
    解疑：频繁创建对象，导致内存不足及碎片（不连续）
          不连续的内存片无法被分配，导致OOM
    内存抖动解决实战
        使用Memory Profiler初步排查
        使用Memory Profiler或 CPU Profiler结合代码排查
        
    内存抖动解决技巧
        找循环或者频繁调用的地方
    总结
        内存抖动
        内存抖动解决实战
### 4-4 内存泄漏解决实战
    内存泄漏介绍
        定义：内存中存在已经没有用的对象
        表现：内存抖动、可用内存逐渐变少
        危害：内存不足、GC频繁、OOM
        
        Memory Analyzer
            https://www.eclipse.org/mat/downloads.php
            转换：hprof-conv 源文件路径 转换后文件路径
            
    内存泄漏解决实战
        .使用Memory Profiler初步观察
        .通过MAT结合代码确认
        
    总结
### 4-5 ARTHook优雅检测不合理图片
    Bitmap内存模型
        .API10之前Bitmap自身在Dalvik Heap中，像素在Native
        .API10之后也被放在Dalvik Heap中
        .API26之后像素在Native
        疑问：如何获取Bitmap占用内存？
        解疑：.getByteCount
              .宽*高*一像素占用内存
        
    常规方式
        背景：
                    图片对内存优化直观重要、图片宽高大于控件宽高
                    实现：集成ImageView，复写实现计算大小，缺点：侵入性强，不通用
    ARTHook实战
        ArtHook挂钩，将额外的代码构筑原有方法，修改执行逻辑
        .运行时插桩
        .性能分析
        Epic简介
            Epic是一个虚拟机层面、以Java Method为力度的运行时Hook框架
            支持Android 4.0 -- 9.0
            https:github.com/tiann/epic
        Epic使用
            compile 'me.weishu:epic:0.3.6'
            继承XC_MethodHook,实现相应逻辑
            注入Hook:DexposedBridge.findAndHookMethod
        总结
            ARTHook实现无侵入性
            通用性强
            兼容问题大，开源方案不能带到线上环境
            
        作业：
            Hook项目中的其他的对象，进行检测
### 线上内存监控方案
    常规方案
        （1）设定场景线上Dump:Debug.dumpHprofData()，生成本地文件
            超过最大内存80% -> 内存Dump -> 回传文件 -> MAT手动分析
            
            Dump文件太大，和对象数正相关，可裁剪
            上传失败率高、分析困难
            配合一定策略，有一定效果
    LeakCanary订制方案
        LeakCanary带到线上
                     预设泄漏怀疑点
                     发现泄漏回传
                     
                     不适合所有情况，必须预设怀疑点
                     分析比较耗时、也容易OOM
                     
                     LeakCanary原理
                        监控生命周期，onDestroy添加RefWatcher检测
                        二次确认断定发生内存泄漏
                        分析泄漏，找引用链
                        监控组件 + 分析组件
                        
                    .预设怀疑点 -> 自动找怀疑点
                    .分析泄漏链路慢 -> 分析Retain size大的对象
                    .分析OOM -> 对象裁剪，不全部加载到内存
    完整方案
        .待机内存、重点模块内存、OOM率
        .整体及重点模块GC次数、GC时间
        .增强的LeakCanary自动化内存泄漏分析
        
    总结
        线上内存泄漏监控的常规方案
        线上内存监控的完整方案
### 4-6 内存优化技巧总结
    优化大方向
        内存泄漏
        内存抖动
        Bitmap
    优化细节
        LargeHeap属性
        onTrimMemory
        onLowMemory
        使用优化过的集合：SparseArray
        谨慎使用SharedPreference
        谨慎使用外部库
        业务架构设计合理
    总结
        内存优化技巧总结
### 4-7 内存优化模拟
    问题：你们内存优化项目的过程是怎么做的？
        .分析现状、确认问题
        .针对性优化
        .效率提升
    问题2：你做了内存优化最大的感受是什么？
        .磨刀不误砍材工
        .技术优化必须结合业务代码
        .系统化完善解决方案
    问题3：如何检测所有不合理的地方？
        .ARTHook
        .重点强调区别
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    